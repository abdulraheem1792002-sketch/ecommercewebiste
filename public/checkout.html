<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Nexus Shop</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <nav class="navbar">
        <div class="container nav-container">
            <a href="/" class="logo"><i class="fas fa-bolt"></i> NEXUS</a>
            <div class="nav-links">
                <a href="/cart.html" class="nav-link"><i class="fas fa-arrow-left"></i> Back to Cart</a>
            </div>
        </div>
    </nav>

    <div class="container section">
        <h1 style="margin-bottom: 2rem;">Checkout</h1>

        <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 2rem;">
            <!-- Checkout Form -->
            <div class="card">
                <h3 style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                    Shipping Information</h3>

                <form id="checkout-form">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="name" class="form-input" required disabled>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="email" class="form-input" required disabled>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Street Address</label>
                        <input type="text" name="street" class="form-input" required placeholder="123 Main St">
                    </div>

                    <div class="grid grid-2" style="gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" name="city" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">State / Province</label>
                            <input type="text" name="state" class="form-input" required>
                        </div>
                    </div>

                    <div class="grid grid-2" style="gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Zip Code</label>
                            <input type="text" name="zipCode" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Country</label>
                            <input type="text" name="country" class="form-input" required value="United States">
                        </div>
                    </div>

                    <h3 style="margin: 2rem 0 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
                        Payment Method</h3>

                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="payment" value="card" checked style="display: none;"
                                onchange="togglePayment(this)">
                            <div class="card" style="text-align: center; border-color: var(--primary);">
                                <i class="far fa-credit-card" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <div>Credit Card</div>
                            </div>
                        </label>
                        <label style="flex: 1; cursor: pointer;">
                            <input type="radio" name="payment" value="paypal" style="display: none;"
                                onchange="togglePayment(this)">
                            <div class="card" style="text-align: center;">
                                <i class="fab fa-paypal" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <div>PayPal</div>
                            </div>
                        </label>
                    </div>

                    <!-- Fake Credit Card Fields -->
                    <div class="grid grid-2" style="gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Card Number</label>
                            <input type="text" class="form-input" placeholder="0000 0000 0000 0000" maxlength="19">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CVV</label>
                            <input type="text" class="form-input" placeholder="123" maxlength="3">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary"
                        style="width: 100%; margin-top: 1rem; font-size: 1.1rem;">
                        Place Order
                    </button>
                </form>
            </div>

            <!-- Order Summary -->
            <div>
                <div class="card" style="position: sticky; top: 100px;">
                    <h3 style="margin-bottom: 1.5rem;">Order Review</h3>
                    <div id="order-items"
                        style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto;">
                        <div class="loader"></div>
                    </div>

                    <div style="border-top: 1px solid var(--border); padding-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Subtotal</span>
                            <span id="summary-subtotal">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Shipping</span>
                            <span id="summary-shipping">$0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Tax</span>
                            <span id="summary-tax">$0.00</span>
                        </div>
                        <div
                            style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.25rem; margin-top: 1rem;">
                            <span>Total</span>
                            <span id="summary-total" style="color: var(--primary-light);">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div id="success-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; width: 90%; text-align: center; padding: 3rem;">
            <div
                style="width: 80px; height: 80px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 2rem;">
                <i class="fas fa-check" style="color: white; font-size: 3rem;"></i>
            </div>
            <h2 style="margin-bottom: 1rem;">Order Placed Successfully!</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                Thank you for your purchase. Your order <span id="order-number"
                    style="color: white; font-weight: 700;">#123</span> has been received.
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <a href="/orders.html" class="btn btn-primary">View Order</a>
                <a href="/" class="btn btn-outline">Continue Shopping</a>
            </div>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', initializeCheckout);

        async function initializeCheckout() {
            // Check auth
            await checkAuth();
            if (!state.user) {
                window.location.href = '/login.html?redirect=/checkout.html';
                return;
            }

            // Pre-fill user info
            document.getElementById('name').value = state.user.name;
            document.getElementById('email').value = state.user.email;

            loadCartSummary();

            // Handle Form Submit
            document.getElementById('checkout-form').addEventListener('submit', placeOrder);
        }

        async function loadCartSummary() {
            try {
                const response = await fetch('/api/cart');
                const data = await response.json();

                if (!data.items || data.items.length === 0) {
                    window.location.href = '/cart.html';
                    return;
                }

                // Render Items
                const itemsContainer = document.getElementById('order-items');
                itemsContainer.innerHTML = data.items.map(item => `
                    <div style="display: flex; gap: 1rem;">
                        <img src="${item.product.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.9rem; font-weight: 500;">${item.product.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Qty: ${item.quantity}</div>
                        </div>
                        <div style="font-weight: 600;">$${(item.product.price * item.quantity).toFixed(2)}</div>
                    </div>
                `).join('');

                // Update Totals
                document.getElementById('summary-subtotal').textContent = '$' + data.summary.subtotal;
                document.getElementById('summary-shipping').textContent = data.summary.shipping === 0 ? 'Free' : '$' + data.summary.shipping;
                document.getElementById('summary-tax').textContent = '$' + data.summary.tax;
                document.getElementById('summary-total').textContent = '$' + data.summary.total;

            } catch (error) {
                console.error(error);
            }
        }

        async function placeOrder(e) {
            e.preventDefault();

            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerHTML = '<div class="loader" style="width: 20px; height: 20px; border-width: 2px;"></div> Processing...';
            btn.disabled = true;

            const formData = new FormData(e.target);
            const shippingAddress = {
                street: formData.get('street'),
                city: formData.get('city'),
                state: formData.get('state'),
                zipCode: formData.get('zipCode'),
                country: formData.get('country')
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shippingAddress,
                        paymentMethod: formData.get('payment')
                    })
                });

                const data = await response.json();

                if (response.status === 201) {
                    document.getElementById('order-number').textContent = data.order.orderNumber;
                    document.getElementById('success-modal').style.display = 'flex';
                } else {
                    showToast(data.message, 'error');
                    btn.innerHTML = 'Place Order';
                    btn.disabled = false;
                }

            } catch (error) {
                showToast('Failed to place order', 'error');
                btn.innerHTML = 'Place Order';
                btn.disabled = false;
            }
        }

        function togglePayment(radio) {
            document.querySelectorAll('input[name="payment"]').forEach(el => {
                el.closest('label').querySelector('.card').style.borderColor =
                    el.checked ? 'var(--primary)' : 'var(--border)';
            });
        }
    </script>
</body>

</html>